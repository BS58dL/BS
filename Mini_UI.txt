-- UI 库核心
local UILibrary = {}

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")

-- Local Player
local LocalPlayer = Players.LocalPlayer
local PlayerMouse = LocalPlayer:GetMouse()
local Workspace = game:GetService("Workspace")
local CurrentCamera = Workspace.CurrentCamera

-- UI Globals
local UDim = UDim.new
local UDim2 = UDim2.new
local Color3 = Color3.fromRGB
local InstanceNew = Instance.new
local TweenInfo = TweenInfo.new

-- 设置全局库对象
_G.Library = UILibrary
getgenv().Library = UILibrary

-- 标记部分（可选，可以删除）
local function CreateMarkers()
    local markers = {}
    
    local vipMarker = InstanceNew("Part", Workspace)
    vipMarker.Position = Vector3.new(-1860.61, -399.9, 927.21)
    vipMarker.Name = "Vip"
    vipMarker.Size = Vector3.new(0, 0.1, 0)
    vipMarker.Anchored = true
    vipMarker.Transparency = 1
    table.insert(markers, vipMarker)
    
    local labMarker = InstanceNew("Part", Workspace)
    labMarker.Position = Vector3.new(-1920.71, -399.9, 929.66)
    labMarker.Name = "Laaabby"
    labMarker.Size = Vector3.new(0, 0.1, 0)
    labMarker.Anchored = true
    labMarker.Transparency = 1
    table.insert(markers, labMarker)
    
    local gameMarker = InstanceNew("Part", Workspace)
    gameMarker.Position = Vector3.new(-0.81, 1, -7.31)
    gameMarker.Name = "Game"
    gameMarker.Size = Vector3.new(0, 0.1, 0)
    gameMarker.Anchored = true
    gameMarker.Transparency = 1
    table.insert(markers, gameMarker)
    
    return markers
end

-- 创建标记（可选）
CreateMarkers()

-- 基础设置
UILibrary.WindowName = "脚本"
UILibrary.Flags = {}
UILibrary.Modules = {}
UILibrary.CurrentTab = nil
UILibrary.Notifications = {}

-- Tween 工具
UILibrary.Tween = function(target, properties, duration, easingStyle, easingDirection)
    return TweenService:Create(target, TweenInfo.new(
        duration or 0.25,
        Enum.EasingStyle[easingStyle or "Linear"],
        Enum.EasingDirection[easingDirection or "InOut"]
    ), properties)
end

-- 切换标签页
UILibrary.SwitchTab = function(newTab)
    local oldTab = UILibrary.CurrentTab
    if oldTab ~= newTab then
        UILibrary.CurrentTab = newTab
        UILibrary.Tween({Transparency = 1}, oldTab[2].Glow):Play()
        UILibrary.Tween({Transparency = 0}, newTab[2].Glow):Play()
        oldTab[1].Visible = false
        newTab[1].Visible = true
    end
end

-- 创建UI
local ScreenGui = InstanceNew("ScreenGui")
ScreenGui.Name = UILibrary.WindowName
ScreenGui.Parent = game:GetService("CoreGui")

-- 主窗口
local MainWindow = InstanceNew("ImageLabel")
MainWindow.Name = "Main"
MainWindow.Parent = ScreenGui
MainWindow.BackgroundColor3 = Color3(52, 62, 72)
MainWindow.BorderSizePixel = 0
MainWindow.Position = UDim2(0.5, 0, 0.5, 0)
MainWindow.Size = UDim2(0, 448, 0, 280)
MainWindow.AnchorPoint = Vector2.new(0.5, 0.5)
MainWindow.Active = true
MainWindow.Draggable = true
MainWindow.Image = "rbxassetid://17281420682"

local MainCorner = InstanceNew("UICorner")
MainCorner.CornerRadius = UDim(0, 6)
MainCorner.Name = "MainCorner"
MainCorner.Parent = MainWindow

-- 标题栏
local TitleBar = InstanceNew("TextLabel")
TitleBar.Parent = MainWindow
TitleBar.BackgroundColor3 = Color3(25, 25, 25)
TitleBar.BorderSizePixel = 0
TitleBar.Position = UDim2(0, 6, 0, 6)
TitleBar.Size = UDim2(0, 436, 0, 24)
TitleBar.Font = Enum.Font.GothamBold
TitleBar.Text = "  " .. UILibrary.WindowName
TitleBar.TextColor3 = Color3(255, 255, 255)
TitleBar.TextSize = 14
TitleBar.TextXAlignment = Enum.TextXAlignment.Left
TitleBar.BackgroundTransparency = 0.75

local TitleCorner = InstanceNew("UICorner")
TitleCorner.CornerRadius = UDim(0, 6)
TitleCorner.Name = "TextLabelCorner"
TitleCorner.Parent = TitleBar

-- 切换按钮
local ToggleButton = InstanceNew("TextButton")
ToggleButton.Name = "Open"
ToggleButton.Parent = ScreenGui
ToggleButton.BackgroundColor3 = MainWindow.BackgroundColor3
ToggleButton.Position = UDim2.new(0.839879155, 0, -0.0123076923, 0)
ToggleButton.BorderSizePixel = 2
ToggleButton.BorderColor3 = TitleBar.BackgroundColor3
ToggleButton.Size = UDim2.new(0, 55, 0, 25)
ToggleButton.Font = Enum.Font.SourceSans
ToggleButton.Text = "隐藏"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextSize = 14
ToggleButton.Active = true
ToggleButton.Draggable = true

local WindowVisible = true
ToggleButton.MouseButton1Down:Connect(function()
    WindowVisible = not WindowVisible
    MainWindow.Visible = WindowVisible
    ToggleButton.Text = WindowVisible and "隐藏" or "打开"
end)

-- 侧边栏
local Sidebar = InstanceNew("Frame")
Sidebar.Name = "Sidebar"
Sidebar.Parent = MainWindow
Sidebar.BackgroundColor3 = Color3(58, 69, 80)
Sidebar.BorderSizePixel = 0
Sidebar.Position = UDim2(0, 6, 0, 36)
Sidebar.Size = UDim2(0, 106, 0, 238)
Sidebar.BackgroundTransparency = 0.75

local SidebarCorner = InstanceNew("UICorner")
SidebarCorner.CornerRadius = UDim(0, 6)
SidebarCorner.Name = "SidebarCorner"
SidebarCorner.Parent = Sidebar

-- 标签按钮容器
local TabButtonsContainer = InstanceNew("ScrollingFrame")
TabButtonsContainer.Name = "TabButtons"
TabButtonsContainer.Parent = Sidebar
TabButtonsContainer.Active = true
TabButtonsContainer.BackgroundColor3 = Color3(255, 255, 255)
TabButtonsContainer.BackgroundTransparency = 1
TabButtonsContainer.BorderSizePixel = 0
TabButtonsContainer.Size = UDim2(0, 106, 0, 238)
TabButtonsContainer.ScrollBarThickness = 0

local TabButtonsLayout = InstanceNew("UIListLayout")
TabButtonsLayout.Parent = TabButtonsContainer
TabButtonsLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
TabButtonsLayout.SortOrder = Enum.SortOrder.LayoutOrder
TabButtonsLayout.Padding = UDim(0, 5)

local TabButtonsPadding = InstanceNew("UIPadding")
TabButtonsPadding.Parent = TabButtonsContainer
TabButtonsPadding.PaddingTop = UDim(0, 6)

-- 标签内容区域
local TabContentArea = InstanceNew("Frame")
TabContentArea.Name = "TabHolder"
TabContentArea.Parent = MainWindow
TabContentArea.BackgroundColor3 = Color3(58, 69, 80)
TabContentArea.BorderSizePixel = 0
TabContentArea.Position = UDim2(0, 118, 0, 36)
TabContentArea.Size = UDim2(0, 324, 0, 238)
TabContentArea.BackgroundTransparency = 0.75

local TabContentCorner = InstanceNew("UICorner")
TabContentCorner.CornerRadius = UDim(0, 6)
TabContentCorner.Name = "TabHolderCorner"
TabContentCorner.Parent = TabContentArea

-- 更新容器大小
TabButtonsLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    TabButtonsContainer.CanvasSize = UDim2(0, 0, 0, TabButtonsLayout.AbsoluteContentSize.Y + 12)
end)

-- 创建标签页函数
UILibrary.CreateTab = function(tabName)
    local tabButton = InstanceNew("TextButton")
    local tabContent = InstanceNew("ScrollingFrame")
    
    -- 标签按钮
    tabButton.Name = "TabButton"
    tabButton.Parent = TabButtonsContainer
    tabButton.BackgroundColor3 = Color3(52, 62, 72)
    tabButton.BorderSizePixel = 0
    tabButton.Size = UDim2(0, 94, 0, 28)
    tabButton.AutoButtonColor = false
    tabButton.Font = Enum.Font.GothamSemibold
    tabButton.Text = tabName
    tabButton.TextColor3 = Color3(255, 255, 255)
    tabButton.TextSize = 14
    tabButton.BackgroundTransparency = 0.75
    
    local tabButtonCorner = InstanceNew("UICorner")
    tabButtonCorner.CornerRadius = UDim(0, 6)
    tabButtonCorner.Name = "TabButtonCorner"
    tabButtonCorner.Parent = tabButton
    
    local glowIndicator = InstanceNew("Frame")
    glowIndicator.Name = "Glow"
    glowIndicator.Parent = tabButton
    glowIndicator.BackgroundColor3 = Color3(255, 255, 255)
    glowIndicator.BorderSizePixel = 0
    glowIndicator.Position = UDim2(0, 0, 0.928571463, 0)
    glowIndicator.Size = UDim2(0, 94, 0, 2)
    glowIndicator.Transparency = 1
    
    -- 标签内容
    tabContent.Name = "Tab"
    tabContent.Parent = TabContentArea
    tabContent.Active = true
    tabContent.BackgroundColor3 = Color3(255, 255, 255)
    tabContent.BackgroundTransparency = 1
    tabContent.BorderSizePixel = 0
    tabContent.Size = UDim2(0, 324, 0, 238)
    tabContent.ScrollBarThickness = 0
    tabContent.Visible = false
    
    local tabLayout = InstanceNew("UIListLayout")
    tabLayout.Name = "TabLayout"
    tabLayout.Parent = tabContent
    tabLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim(0, 5)
    
    local tabPadding = InstanceNew("UIPadding")
    tabPadding.Name = "TabPadding"
    tabPadding.Parent = tabContent
    tabPadding.PaddingTop = UDim(0, 6)
    
    -- 设置第一个标签为默认
    if not UILibrary.CurrentTab then
        UILibrary.CurrentTab = {tabContent, tabButton}
        glowIndicator.Transparency = 0
        tabContent.Visible = true
    end
    
    -- 更新内容大小
    tabLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        tabContent.CanvasSize = UDim2(0, 0, 0, tabLayout.AbsoluteContentSize.Y + 12)
    end)
    
    -- 标签切换
    tabButton.MouseButton1Click:Connect(function()
        UILibrary.SwitchTab({tabContent, tabButton})
    end)
    
    -- 返回UI元素构建器
    return {
        -- 添加分隔符
        Separator = function()
            local separator = InstanceNew("Frame")
            separator.Transparency = 1
            separator.Size = UDim2(0, 0, 0, 0)
            separator.BorderSizePixel = 0
            separator.Parent = tabContent
        end,
        
        -- 添加按钮
        Button = function(buttonText, callback)
            local button = InstanceNew("TextButton")
            button.Name = "BtnModule"
            button.Parent = tabContent
            button.BackgroundColor3 = Color3(52, 62, 72)
            button.BorderSizePixel = 0
            button.Size = UDim2(0, 312, 0, 28)
            button.AutoButtonColor = false
            button.Font = Enum.Font.GothamSemibold
            button.Text = "  " .. buttonText
            button.TextColor3 = Color3(255, 255, 255)
            button.TextSize = 14
            button.TextXAlignment = Enum.TextXAlignment.Left
            button.BackgroundTransparency = 0.75
            
            local buttonCorner = InstanceNew("UICorner")
            buttonCorner.CornerRadius = UDim(0, 6)
            buttonCorner.Name = "BtnModuleCorner"
            buttonCorner.Parent = button
            
            if callback then
                button.MouseButton1Click:Connect(callback)
            end
        end,
        
        -- 添加开关
        Toggle = function(toggleName, flagName, defaultValue, callback)
            local toggleState = defaultValue or false
            
            local toggleContainer = InstanceNew("TextButton")
            toggleContainer.Name = "ToggleModule"
            toggleContainer.Parent = tabContent
            toggleContainer.BackgroundColor3 = Color3(52, 62, 72)
            toggleContainer.BorderSizePixel = 0
            toggleContainer.Size = UDim2(0, 312, 0, 28)
            toggleContainer.AutoButtonColor = false
            toggleContainer.Font = Enum.Font.GothamSemibold
            toggleContainer.Text = "  " .. toggleName
            toggleContainer.TextColor3 = Color3(255, 255, 255)
            toggleContainer.TextSize = 14
            toggleContainer.TextXAlignment = Enum.TextXAlignment.Left
            toggleContainer.BackgroundTransparency = 0.75
            
            local toggleCorner = InstanceNew("UICorner")
            toggleCorner.CornerRadius = UDim(0, 6)
            toggleCorner.Name = "ToggleModuleCorner"
            toggleCorner.Parent = toggleContainer
            
            -- 关闭状态指示器
            local offIndicator = InstanceNew("Frame")
            offIndicator.Name = "OffStatus"
            offIndicator.Parent = toggleContainer
            offIndicator.BackgroundColor3 = Color3(255, 255, 255)
            offIndicator.BorderSizePixel = 0
            offIndicator.Position = UDim2(0.878205061, 0, 0.178571433, 0)
            offIndicator.Size = UDim2(0, 34, 0, 18)
            
            -- 打开状态指示器
            local onIndicator = InstanceNew("Frame")
            onIndicator.Name = "OnStatus"
            onIndicator.Parent = toggleContainer
            onIndicator.BackgroundColor3 = Color3(255, 255, 255)
            onIndicator.BackgroundTransparency = 1
            onIndicator.BorderSizePixel = 0
            onIndicator.Position = UDim2(0.878205121, 0, 0.178571433, 0)
            onIndicator.Size = UDim2(0, 34, 0, 18)
            onIndicator.Transparency = 1
            
            -- 存储在Flags中
            UILibrary.Flags[flagName or toggleName] = {
                State = toggleState,
                Callback = callback or function() end,
                SetState = function(newState)
                    if newState == nil then
                        newState = not UILibrary.Flags[flagName or toggleName].State
                    end
                    UILibrary.Flags[flagName or toggleName].State = newState
                    if callback then callback(newState) end
                    
                    -- 更新视觉状态
                    UILibrary.Tween({Transparency = newState and 1 or 0}, offIndicator):Play()
                    UILibrary.Tween({Transparency = newState and 0 or 1}, onIndicator):Play()
                end
            }
            
            -- 点击处理
            toggleContainer.MouseButton1Click:Connect(function()
                UILibrary.Flags[flagName or toggleName]:SetState()
            end)
            
            -- 设置初始状态
            if defaultValue then
                UILibrary.Flags[flagName or toggleName]:SetState(defaultValue)
            end
        end,
        
        -- 添加文本标签
        Label = function(labelText)
            local label = InstanceNew("TextLabel")
            label.Name = "LabelModule"
            label.Parent = tabContent
            label.BackgroundColor3 = Color3(52, 62, 72)
            label.BackgroundTransparency = 0.75
            label.BorderSizePixel = 0
            label.Size = UDim2(0, 312, 0, 28)
            label.Font = Enum.Font.GothamSemibold
            label.Text = "  " .. labelText
            label.TextColor3 = Color3(255, 255, 255)
            label.TextSize = 14
            label.TextXAlignment = Enum.TextXAlignment.Left
        end,
        
        -- 添加文本框
        Textbox = function(textboxName, placeholder, callback)
            local textboxContainer = InstanceNew("TextButton")
            textboxContainer.Name = "TextboxModule"
            textboxContainer.Parent = tabContent
            textboxContainer.BackgroundColor3 = Color3(52, 62, 72)
            textboxContainer.BackgroundTransparency = 0.75
            textboxContainer.BorderSizePixel = 0
            textboxContainer.Size = UDim2(0, 312, 0, 28)
            textboxContainer.AutoButtonColor = false
            textboxContainer.Font = Enum.Font.GothamSemibold
            textboxContainer.Text = "  " .. textboxName
            textboxContainer.TextColor3 = Color3(255, 255, 255)
            textboxContainer.TextSize = 14
            textboxContainer.TextXAlignment = Enum.TextXAlignment.Left
            
            local textboxCorner = InstanceNew("UICorner")
            textboxCorner.CornerRadius = UDim(0, 6)
            textboxCorner.Name = "BoxButtonCorner"
            textboxCorner.Parent = textboxContainer
            
            local inputBox = InstanceNew("TextBox")
            inputBox.Name = "Box"
            inputBox.Parent = textboxContainer
            inputBox.BackgroundColor3 = Color3(58, 69, 80)
            inputBox.BackgroundTransparency = 0.75
            inputBox.BorderSizePixel = 0
            inputBox.Position = UDim2(0.774615362, 0, 0.178571433, 0)
            inputBox.Size = UDim2(0, 65, 0, 18)
            inputBox.Font = Enum.Font.Gotham
            inputBox.Text = ""
            inputBox.PlaceholderText = placeholder
            inputBox.TextColor3 = Color3(255, 255, 255)
            inputBox.TextSize = 12
            
            local inputCorner = InstanceNew("UICorner")
            inputCorner.CornerRadius = UDim(0, 4)
            inputCorner.Name = "BoxCorner"
            inputCorner.Parent = inputBox
            
            inputBox.FocusLost:Connect(function(enterPressed)
                if enterPressed then
                    if callback then callback(inputBox.Text) end
                    inputBox.Text = ""
                end
            end)
        end
    }
end

-- 设置UI库全局可用
return UILibrary